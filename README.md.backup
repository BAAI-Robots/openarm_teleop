# OpenArm Teleop

OpenArm supports multiple control modes:
- ğŸ¤ 1:1 teleoperation from a leader arm to a follower arm
- ğŸ® **VR control with ROS2 integration**
- âŒ¨ï¸ **Keyboard/Mouse control (Minecraft-style)**
- ğŸ¤– **Pure simulation mode (no hardware required)**
- ğŸ§  **7-DOF Inverse kinematics** for end-effector pose control

## ğŸ¯ Robot Configuration

**OpenArm v10 Follower**
- **7 DOF**: 7 revolute joints (redundant arm)
- **Kinematics**: KDL-based FK/IK solver
- **IK Success Rate**: 80-90% (typical for 7-DOF arms)
- **Dual Arm Support**: Left + Right arms (14 joints total)

See [KINEMATICS_7DOF.md](KINEMATICS_7DOF.md) forè¯¦ç»†çš„7è‡ªç”±åº¦è¿åŠ¨å­¦è¯´æ˜ã€‚

See the [documentation](https://docs.openarm.dev/teleop/) for traditional teleop details.

---

## ğŸš€ Quick Start

### CAN Bus Setup

First, configure the CAN interface:

```bash
sudo ip link set can0 down
sudo ip link set can0 type can bitrate 1000000
sudo ip link set can0 up

sudo ip link set can1 down
sudo ip link set can1 type can bitrate 1000000
sudo ip link set can1 up
```

### Build the Project

```bash
cd /home/robot/openarm_teleop
mkdir -p build && cd build

# Source ROS2 environment
source /opt/ros/humble/setup.bash

# Configure and build
cmake ..
make

# Verify executables
ls -lh vr_control_example ik_test
```

---

## ğŸ® VR Control Mode (ROS2)

### 1. Generate URDF Files

Before starting VR control, generate the robot URDF:

```bash
mkdir -p /tmp/openarm_urdf_gen
xacro ~/ros2_ws/src/openarm_description/urdf/robot/v10.urdf.xacro \
      bimanual:=true \
      -o /tmp/openarm_urdf_gen/v10_leader.urdf
```

### 2. Start the VR Control Program

**On the robot side:**

```bash
cd /home/robot/openarm_teleop/build

# Option 1: Using default parameters (can0, right_arm)
./vr_control_example

# Option 2: Specify parameters
./vr_control_example can0 /tmp/openarm_urdf_gen/v10_leader.urdf right_arm
```

**What it does:**
- âœ… Initializes OpenArm hardware (CAN interface)
- âœ… Initializes IK solver for end-effector control
- âœ… Starts 500Hz control loop
- âœ… Publishes robot state at 50Hz to ROS2 topics
- âœ… Listens for VR commands on ROS2 topics

**Expected output:**
```
=== OpenArm VR Control Example ===
CAN Interface: can0
[INFO] Initializing IK solver...
[IKSolver] Using KDL LMA solver
[Dynamics] IK Solver initialized successfully
[INFO] Initializing OpenArm hardware...
Arm motors: 6
Hand motors: 1
[INFO] Initializing ROS2 Publisher...
[INFO] Initializing VR Control Interface...
[VR Control] Thread started

=== VR Control Active ===
Waiting for VR commands on topics:
  - /robot/joint_command
  - /robot/ee_pose_command
  - /robot/gripper_command

Publishing robot state on:
  - /robot/joint_states
  - /robot/ee_pose

Press Ctrl+C to exit...
```

---

## ğŸ® Keyboard Mouse Control (Minecraft Style)

Control the robot using keyboard and mouse, similar to Minecraft!

### Quick Start

```bash
# One-line launch (auto tmux multi-window)
./launch_keyboard_control.sh

# Or manual Python script
python3 keyboard_mouse_control.py
```

### Controls

| Key | Action |
|-----|--------|
| **W/S** | Forward/Backward |
| **A/D** | Left/Right |
| **Shift/Space** | Down/Up |
| **Q/E** | Roll Left/Right |
| **Mouse Move** | Pitch & Yaw |
| **G** | Toggle Gripper |
| **R** | Reset Pose |
| **ESC** | Exit |

### Launch Modes

The script supports 4 launch modes:
1. **Full Mode**: Robot + Keyboard Control + RViz (auto tmux)
2. **Keyboard Only**: Control interface only
3. **RViz Only**: Visualization only
4. **Test Mode**: No real robot required

**Dependencies:**
```bash
sudo apt install python3-pygame tmux
pip3 install pygame
```

**See:** [QUICKSTART_VR.md](QUICKSTART_VR.md) for detailed keyboard control guide.

---

## ğŸ“¡ VRç«¯ ROS2 è¯é¢˜æ¥å£

### VRç«¯éœ€è¦å‘å¸ƒçš„è¯é¢˜ï¼ˆæ§åˆ¶æœºå™¨äººï¼‰

#### 1. å…³èŠ‚æ§åˆ¶ï¼ˆç›´æ¥æ§åˆ¶ï¼‰

```bash
# Topic: /robot/joint_command
# Type: sensor_msgs/msg/JointState
# Description: ç›´æ¥è®¾ç½®å…³èŠ‚è§’åº¦

ros2 topic pub /robot/joint_command sensor_msgs/msg/JointState '{
  position: [0.0, 0.5, -0.3, 0.2, 0.1, -0.4, 0.0]
}' --once
```

**Pythonç¤ºä¾‹ï¼š**
```python
import rclpy
from sensor_msgs.msg import JointState

# åˆ›å»ºå‘å¸ƒå™¨
joint_pub = node.create_publisher(JointState, '/robot/joint_command', 10)

# å‘å¸ƒå…³èŠ‚å‘½ä»¤
msg = JointState()
msg.position = [0.0, 0.5, -0.3, 0.2, 0.1, -0.4, 0.0]  # 6ä¸ªæ‰‹è‡‚å…³èŠ‚ + 1ä¸ªå¤¹çˆª
joint_pub.publish(msg)
```

#### 2. æœ«ç«¯ä½å§¿æ§åˆ¶ï¼ˆè‡ªåŠ¨IKæ±‚è§£ï¼‰âœ¨

```bash
# Topic: /robot/ee_pose_command
# Type: geometry_msgs/msg/PoseStamped
# Description: è®¾ç½®æœ«ç«¯æ‰§è¡Œå™¨ä½å§¿ï¼Œç³»ç»Ÿè‡ªåŠ¨æ±‚è§£IK

ros2 topic pub /robot/ee_pose_command geometry_msgs/msg/PoseStamped '{
  header: {frame_id: "world"},
  pose: {
    position: {x: 0.3, y: 0.2, z: 0.5},
    orientation: {w: 1.0, x: 0.0, y: 0.0, z: 0.0}
  }
}' --once
```

**Pythonç¤ºä¾‹ï¼š**
```python
from geometry_msgs.msg import PoseStamped

# åˆ›å»ºå‘å¸ƒå™¨
pose_pub = node.create_publisher(PoseStamped, '/robot/ee_pose_command', 10)

# å‘å¸ƒæœ«ç«¯ä½å§¿å‘½ä»¤
msg = PoseStamped()
msg.header.frame_id = 'world'
msg.pose.position.x = 0.3
msg.pose.position.y = 0.2
msg.pose.position.z = 0.5
msg.pose.orientation.w = 1.0  # å•ä½å››å…ƒæ•°
pose_pub.publish(msg)

# IKæ±‚è§£è‡ªåŠ¨æ‰§è¡Œï¼Œæ— éœ€VRç«¯è®¡ç®—
```

#### 3. å¤¹çˆªæ§åˆ¶

```bash
# Topic: /robot/gripper_command
# Type: std_msgs/msg/Float64MultiArray
# Description: è®¾ç½®å¤¹çˆªå¼€åˆåº¦

ros2 topic pub /robot/gripper_command std_msgs/msg/Float64MultiArray '{
  data: [0.5]
}' --once
```

**Pythonç¤ºä¾‹ï¼š**
```python
from std_msgs.msg import Float64MultiArray

gripper_pub = node.create_publisher(Float64MultiArray, '/robot/gripper_command', 10)

msg = Float64MultiArray()
msg.data = [0.5]  # 0.0 = å®Œå…¨é—­åˆ, 1.0 = å®Œå…¨æ‰“å¼€
gripper_pub.publish(msg)
```

---

### VRç«¯éœ€è¦è®¢é˜…çš„è¯é¢˜ï¼ˆè·å–æœºå™¨äººçŠ¶æ€ï¼‰

#### 1. å…³èŠ‚çŠ¶æ€åé¦ˆ

```bash
# Topic: /robot/joint_states
# Type: sensor_msgs/msg/JointState
# Frequency: 50Hz

ros2 topic echo /robot/joint_states
```

**Pythonç¤ºä¾‹ï¼š**
```python
from sensor_msgs.msg import JointState

def joint_state_callback(msg):
    print(f"Received {len(msg.position)} joint positions:")
    for i, pos in enumerate(msg.position):
        print(f"  Joint {i}: {pos:.3f} rad")

joint_sub = node.create_subscription(
    JointState, '/robot/joint_states', joint_state_callback, 10)
```

#### 2. æœ«ç«¯ä½å§¿åé¦ˆ

```bash
# Topic: /robot/ee_pose
# Type: geometry_msgs/msg/PoseStamped
# Frequency: 50Hz

ros2 topic echo /robot/ee_pose
```

**Pythonç¤ºä¾‹ï¼š**
```python
from geometry_msgs.msg import PoseStamped

def ee_pose_callback(msg):
    pos = msg.pose.position
    ori = msg.pose.orientation
    print(f"End-effector pose:")
    print(f"  Position: [{pos.x:.3f}, {pos.y:.3f}, {pos.z:.3f}]")
    print(f"  Orientation: [{ori.w:.3f}, {ori.x:.3f}, {ori.y:.3f}, {ori.z:.3f}]")

ee_sub = node.create_subscription(
    PoseStamped, '/robot/ee_pose', ee_pose_callback, 10)
```

---

## ğŸ§ª æµ‹è¯•VRæ¥å£

### 1. æµ‹è¯•IKæ±‚è§£å™¨

```bash
cd /home/robot/openarm_teleop/build
./ik_test
```

**é¢„æœŸè¾“å‡ºï¼š**
```
[âœ“] Test Case 1: Zero Configuration
    Position error: 0.0000 m
[âœ“] Test Case 2: Random Configuration
    Position error: 0.0000 m
```

### 2. è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬

```bash
cd /home/robot/openarm_teleop
chmod +x test_vr_interface.sh
./test_vr_interface.sh
```

### 3. æ‰‹åŠ¨æµ‹è¯•VRå‘½ä»¤

**ç»ˆç«¯1** - å¯åŠ¨VRæ§åˆ¶ç¨‹åºï¼š
```bash
cd /home/robot/openarm_teleop/build
./vr_control_example
```

**ç»ˆç«¯2** - å‘é€æµ‹è¯•å‘½ä»¤ï¼š
```bash
# æµ‹è¯•å…³èŠ‚æ§åˆ¶
ros2 topic pub /robot/joint_command sensor_msgs/msg/JointState '{
  position: [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]
}' --once

# æµ‹è¯•æœ«ç«¯ä½å§¿æ§åˆ¶
ros2 topic pub /robot/ee_pose_command geometry_msgs/msg/PoseStamped '{
  pose: {
    position: {x: 0.3, y: 0.2, z: 0.4},
    orientation: {w: 1.0, x: 0.0, y: 0.0, z: 0.0}
  }
}' --once

# æµ‹è¯•å¤¹çˆªæ§åˆ¶
ros2 topic pub /robot/gripper_command std_msgs/msg/Float64MultiArray '{
  data: [0.5]
}' --once
```

**ç»ˆç«¯3** - ç›‘æ§æœºå™¨äººçŠ¶æ€ï¼š
```bash
# æŸ¥çœ‹å…³èŠ‚çŠ¶æ€
ros2 topic echo /robot/joint_states

# æŸ¥çœ‹æœ«ç«¯ä½å§¿
ros2 topic echo /robot/ee_pose
```

---

## ğŸ“Š ROS2è¯é¢˜æ€»è§ˆ

| è¯é¢˜åç§° | æ¶ˆæ¯ç±»å‹ | æ–¹å‘ | é¢‘ç‡ | åŠŸèƒ½ |
|---------|---------|------|------|------|
| `/robot/joint_command` | `sensor_msgs/JointState` | VR â†’ æœºå™¨äºº | æŒ‰éœ€ | å…³èŠ‚æ§åˆ¶ |
| `/robot/ee_pose_command` | `geometry_msgs/PoseStamped` | VR â†’ æœºå™¨äºº | æŒ‰éœ€ | æœ«ç«¯ä½å§¿æ§åˆ¶ï¼ˆè‡ªåŠ¨IKï¼‰ |
| `/robot/gripper_command` | `std_msgs/Float64MultiArray` | VR â†’ æœºå™¨äºº | æŒ‰éœ€ | å¤¹çˆªæ§åˆ¶ |
| `/robot/joint_states` | `sensor_msgs/JointState` | æœºå™¨äºº â†’ VR | 50Hz | å…³èŠ‚çŠ¶æ€åé¦ˆ |
| `/robot/ee_pose` | `geometry_msgs/PoseStamped` | æœºå™¨äºº â†’ VR | 50Hz | æœ«ç«¯ä½å§¿åé¦ˆ |

---

## ğŸ¤ Traditional Teleop Mode

For traditional leader-follower teleop:

```bash
cd /home/robot/openarm_teleop/build

# Unilateral control
./unilateral_control can0 can1

# Bilateral control
./bilateral_control can0 can1

# Gravity compensation only
./gravity_comp can0
```

---

## ğŸ­ ä»¿çœŸæ¨¡å¼ï¼ˆSimulation Modeï¼‰

### æ— éœ€ç¡¬ä»¶ï¼Œçº¯è½¯ä»¶ä»¿çœŸ

**å¿«é€Ÿå¯åŠ¨ï¼š**
```bash
./test_simulation.sh
```

**å®Œæ•´ç³»ç»Ÿï¼ˆtmuxå¤šçª—å£ï¼‰ï¼š**
```bash
./launch_simulation.sh  # é€‰æ‹©æ¨¡å¼1
```

**ç‰¹ç‚¹ï¼š**
- âœ… æ— éœ€CANæ¥å£å’ŒçœŸå®æœºå™¨äºº
- âœ… ä½¿ç”¨KDLè¿›è¡Œè¿åŠ¨å­¦è®¡ç®—
- âœ… **ä½¿ç”¨çœŸå®çš„OpenArm v10 URDFæ¨¡å‹**
- âœ… æ”¯æŒé”®ç›˜é¼ æ ‡æ§åˆ¶
- âœ… ROS2è¯é¢˜å®Œå…¨å…¼å®¹
- âœ… é€‚åˆç®—æ³•æµ‹è¯•å’ŒUIå¼€å‘

**è¯¦ç»†æ–‡æ¡£ï¼š** [SIMULATION_GUIDE.md](SIMULATION_GUIDE.md)

---

## ğŸ“š Documentation

- ğŸ­ **[SIMULATION_GUIDE.md](SIMULATION_GUIDE.md)** - ä»¿çœŸæ¨¡å¼ä½¿ç”¨æŒ‡å—ï¼ˆæ— éœ€ç¡¬ä»¶ï¼‰
- ğŸ“ **[URDF_SETUP.md](URDF_SETUP.md)** - URDFé…ç½®è¯´æ˜ï¼ˆä½¿ç”¨çœŸå®æ¨¡å‹ï¼‰
- ğŸ® **[KEYBOARD_MOUSE_CONTROL.md](KEYBOARD_MOUSE_CONTROL.md)** - é”®ç›˜é¼ æ ‡æ§åˆ¶è¯´æ˜
- ğŸ“– **[IK_SOLVER_GUIDE.md](IK_SOLVER_GUIDE.md)** - IKæ±‚è§£å™¨è¯¦ç»†æ–‡æ¡£
- ğŸ“ **[IK_QUICK_REFERENCE.md](IK_QUICK_REFERENCE.md)** - IKå¿«é€Ÿå‚è€ƒ
- ğŸ® **[VR_CONTROL_INTERFACE.md](VR_CONTROL_INTERFACE.md)** - VRæ§åˆ¶æ¥å£è¯´æ˜
- ğŸ“Š **[IK_IMPLEMENTATION_SUMMARY.md](IK_IMPLEMENTATION_SUMMARY.md)** - å®ç°æ€»ç»“
- ğŸŒ **[Official Docs](https://docs.openarm.dev/teleop/)** - OpenArmå®˜æ–¹æ–‡æ¡£

---

## ğŸ”§ Troubleshooting

### IKæ±‚è§£å¤±è´¥ï¼Ÿ
1. æ£€æŸ¥ç›®æ ‡ä½ç½®æ˜¯å¦åœ¨å·¥ä½œç©ºé—´å†…ï¼ˆé€šå¸¸ <0.6mï¼‰
2. ç¡®è®¤URDFæ–‡ä»¶å·²æ­£ç¡®ç”Ÿæˆ
3. æŸ¥çœ‹è¯¦ç»†æ—¥å¿—ï¼š`./vr_control_example` ä¼šè¾“å‡ºIKæ±‚è§£çŠ¶æ€

### ROS2è¯é¢˜æ— æ³•å‘å¸ƒï¼Ÿ
```bash
# æ£€æŸ¥ROS2ç¯å¢ƒ
source /opt/ros/humble/setup.bash

# æ£€æŸ¥è¯é¢˜åˆ—è¡¨
ros2 topic list

# æ£€æŸ¥è¯é¢˜ä¿¡æ¯
ros2 topic info /robot/joint_command
```

### CANæ€»çº¿é”™è¯¯ï¼Ÿ
```bash
# æ£€æŸ¥CANæ¥å£çŠ¶æ€
ip link show can0
ip link show can1

# é‡æ–°é…ç½®CANæ€»çº¿ï¼ˆå‚è€ƒä¸Šæ–¹CAN Bus Setupï¼‰
```

---

## ğŸ“¬ Contact & Community

- ğŸ“š Read the [documentation](https://docs.openarm.dev/teleop/)
- ğŸ’¬ Join the community on [Discord](https://discord.gg/FsZaZ4z3We)
- ğŸ“¬ Contact us through <openarm@enactic.ai>

---

## âš–ï¸ License

Licensed under the Apache License 2.0. See [LICENSE.txt](LICENSE.txt) for details.

Copyright 2025 Enactic, Inc.

## ğŸ¤ Code of Conduct

All participation in the OpenArm project is governed by our [Code of Conduct](CODE_OF_CONDUCT.md).
